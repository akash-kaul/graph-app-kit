# Amazon Neptune setup and graph-app-kit configuration

[Amazon Neptune](https://aws.amazon.com/neptune/) is a:

> ... &quot;fast, reliable, fully managed graph database service that makes it easy to build and run applications that work with highly connected datasets&quot;

It supports both property graph queries with [Apache Gremlin/Tinkerpop](https://tinkerpop.apache.org/) queries, and RDF graphs with SPAQL queries.

By using `graph-app-kit` with Amazon Neptune, you can visually explore graph database data and share point-and-click dashboard tools. This guides walks through launching Neptune, `graph-app-kit`, and connecting them. The CloudFormation templates enable quick launching preconfigured versions of both.

## 1. Setup Amazon Neptune


### Option: Manual

Ensure your Amazon Neptune database instance can be connected to by your `graph-app-kit` instance:

- You must have or create an Amazon Neptune cluster. See the official [Getting Started with Neptune docs](https://docs.aws.amazon.com/neptune/latest/userguide/get-started.html).

- Amazon Neptune clusters are hosted in a private VPC so the server hosting `graph-app-kit` must be [granted access to the VPC](https://docs.aws.amazon.com/neptune/latest/userguide/security-vpc.html). We strongly recommend hosting the `graph-app-kit` instance in a public subnet within the Neptune database's VPC. Alternatively, with (much) more configuration, you can try VPC peering between subnets, with communication opened for port 8182 on the Neptune IP, and all ideally running in the same availability zone.

- If using IAM authorization on your Amazon Neptune cluster the sample code provided will need to be updated to support using SigV4 signing of requests. We recommend using [this tool](https://github.com/awslabs/amazon-neptune-tools/tree/master/neptune-python-utils) to simplify the process.

### Option: Quick launch prepopulated Customer Identity Graph database

Quick launch the customer identity graph database using the [identity graph sample cloud formation templates](https://aws.amazon.com/blogs/database/building-a-customer-identity-graph-with-amazon-neptune/) buttons at the bottom:

1. Click `Launch Stack` button for your region. If using GPUs, ensure it is a region where you have GPU quota.
2. Check the acknowledgement boxes in the `Capabilities` section
3. Click `Create Stack` (5-20min)
  *  The root `Identity-Graph-Sample` item's `Output` tab will show values used to configure the next steps:

      * `VPC`: ID `vpc-abc`
      * `PublicSubnet1`: ID `subnet-abc`
          * Optional verification: Inspecting the AWS Console (`Services` -> `VPC` -> `Subnets`) should report `Auto-assign public IPv4 address: Yes `
      * `DBClusterReadEndpoint`: URL
4. *Optional POC $ saver*: After successful optimized launch, downgrade to a smaller instance type: 
  * `AWS Console` -> `Services` -> `Neptune` -> `Databases` -> **Modify** the **Writer**
  * Change *DB instance class* to *db.r4.large* -> `Continue` -> check **Apply immediately** -> `Modify DB Instance`


You can always return to the stack by `AWS Console` -> `Services` -> `CloudFormation` -> `Stacks` . It enables you to inspect the generated stack as well as use the `delete` button to safely remove any resources generated by this step.

## 2. Launch and configure graph-app-kit for Amazon Neptune


### Option: Manual

Create an AWS EC2 `graph-app-kit` instance using the usual [graph-app-kit first launch step](steps.md), with the following launch settings:

  1. Set `Network` to the `VPC` ID value ("`vpc-...`") from `1. Setup Amazon Neptune` (unless performing an alternative like manual VPC peering)
  2. Set `Subnet` to the `PublicSubnet1` subnet ID value ("`subnet-...`") from `1. Setup Amazon Neptune`
      * `Auto-assign Public IP` should default to `Use subnet setting (Enable)`

Continue through the [graph-app-kit steps to download and build](steps.md).


SSH into your `graph-app-kit` instance and set the following required environment variable configurations in your [src/docker/.env](src/docker/.env) file:

```bash
NEPTUNE_READER_PROTOCOL=wss
NEPTUNE_READER_HOST=<Insert Neptune DBClusterReadEndpoint like abc.xyz.mno.neptune.amazonaws.com>
NEPTUNE_READER_PORT=8182
```

For additional template options, see [src/envs/neptune.env](src/envs/neptune.env).

Reset and restart your `graph-app-kit` container: 

```bash
cd src/docker
sudo docker-compose down -v
sudo docker-compose up -d
```

Watch logs with `sudo docker-compose logs -f -t --tail=1`

### Option: Quicklaunch

Open the Cloudformation template launcher in the same region as your Neptune instance and use the Neptune template file

Launch the template with the following settings:

  * Form `Details`:
    1. Set stack name to anything, such as `graph-app-kit-a`
    1. Set `VPC` to the `VPC` ID value ("`vpc-...`") from `1. Setup Amazon Neptune`
    1. Set `Subnet` to the `PublicSubnet1` subnet ID value ("`subnet-...`") from `1. Setup Amazon Neptune`
    1. Set `GraphAppKitKeyPair` to any where you have the SSH private.key
  * Form `Options`:
    * Recommended: Add tag `name` => `graph-app-kit-a`

Upon launch, an instance should start in your AWS console for that region. 

SSH in and watch the initialization logs for errors:

```bash
ssh -i /my/private.key ubuntu@the.instance.public.ip
tail -f /var/log/cloud-init-output.log -n 100
```

Upon successful complete, you should have 2 URLs:

* http://the.public.ip.address : Graphistry, with account `admin` and password `your-aws-instance-id`
  * Installed at `/home/ubuntu/graphistry`
* http://the.public.ip.address:8501 : Streamlit
  * Installed at `/home/ubuntu/graph-app-kit/public/graph-app-kit`

## 4. Graph!

* Go to http://your.public.ip.address:8501: A demo StreamLit + Graphistry dashboard should load
* Select `GREMLIN: SIMPLE SAMPLE` from the dropdown to load a random sample of nodes from whatever Neptune database is connected
* Continue to the instructions for [creating custom views](views.md) and [adding common extensions](extend.md) like TLS, public/private dashboards, and more


## Advanced: Local Developement

As Amazon Neptune runs in a private VPC, it exposes no internet-accessible API endpoints, so local development requires additional steps. Options to connect to Amazon Neptune from a local computer include:

* Setup an SSH tunnel for your internet connections

* Configure a load balancer to expose the Neptune endpoint

* Choose another way to configure secure access to a private VPC in AWS.
Check the [Getting Started with Neptune](https://docs.aws.amazon.com/neptune/latest/userguide/get-started.html) page for the current best recommended practices.
